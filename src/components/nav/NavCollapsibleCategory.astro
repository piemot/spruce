---
import Link from "../Link.astro";
import { ChevronRightIcon } from "@lucide/astro";

interface Props {
  name: string;
  href: string;
  pages: { href: string; name: string; current: boolean }[];
}

const props = Astro.props;
---

<collapsible-element data-open="">
  <li class="list-none">
    <span class="flex items-center gap-1 font-semibold text-accent-primary">
      <ChevronRightIcon class="click-target size-5 transition data-open:rotate-90" />
      <Link href={props.href}>{props.name}</Link>
    </span>
    <div class="collapse-target grid grid-rows-[0fr] transition-[grid-template-rows] data-open:grid-rows-[1fr]">
      <ul class="overflow-hidden pl-6 text-gray-600 *:hover:text-gray-800">
        {
          props.pages.map((page) =>
            page.current ? (
              <li>
                <Link href={page.href} class="text-accent-secondary" aria-current="page">
                  {page.name}
                </Link>
              </li>
            ) : (
              <li>
                <Link href={page.href}>{page.name}</Link>
              </li>
            )
          )
        }
      </ul>
    </div>
  </li>
</collapsible-element>

<script>
  class CollapsibleElement extends HTMLElement {
    connectedCallback() {
      let isOpen = this.dataset.open !== undefined;

      const clickTargets: NodeListOf<HTMLElement> = this.querySelectorAll(".click-target")!;
      const collapseTarget: HTMLElement = this.querySelector(".collapse-target")!;

      this.updateElement(this, isOpen);
      this.updateElement(collapseTarget, isOpen);

      const onClick = () => {
        isOpen = !isOpen;

        this.updateElement(this, isOpen);
        this.updateElement(collapseTarget, isOpen);
        for (const clickTarget of clickTargets) {
          this.updateElement(clickTarget, isOpen);
        }
      };

      for (const clickTarget of clickTargets) {
        this.updateElement(clickTarget, isOpen);
        clickTarget.addEventListener("click", onClick);
      }
    }

    updateElement(elem: HTMLElement, isOpen: boolean) {
      if (isOpen) {
        elem.dataset.open = "";
        delete elem.dataset.closed;
      } else {
        elem.dataset.closed = "";
        delete elem.dataset.open;
      }
    }
  }

  customElements.define("collapsible-element", CollapsibleElement);
</script>
